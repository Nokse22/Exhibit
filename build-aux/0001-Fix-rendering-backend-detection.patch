From d82c78da0065353d832332eceb059ab7fa459a05 Mon Sep 17 00:00:00 2001
From: Nokse <nokse@posteo.com>
Date: Tue, 20 Jan 2026 15:57:06 +0100
Subject: [PATCH] Fix rendering backend detection

---
 library/public/context.h | 16 +++++++++-------
 library/src/context.cxx  | 32 ++++++++++++++++++++++----------
 2 files changed, 31 insertions(+), 17 deletions(-)

diff --git a/library/public/context.h b/library/public/context.h
index f30cca8..dcdd4a3 100644
--- a/library/public/context.h
+++ b/library/public/context.h
@@ -7,6 +7,7 @@
 /// @cond
 #include <functional>
 #include <string>
+#include <vector>
 /// @endcond
 
 namespace f3d
@@ -66,14 +67,15 @@ public:
   [[nodiscard]] static function osmesa();
 
   /**
-   * Create a context function from a library name and a function name.
-   * The library name must be specified without its prefix and extension.
-   * For example, `getSymbol("EGL", "eglGetProcAddress")` looks for the symbol
-   * `eglGetProcAddress` in the library `libEGL.so` on Linux.
-   * Throw a loading_exception if it fails to find the library or a symbol_exception
-   * if the lib does not contains the expected symbol.
+   * Create a context function from a list of library names and a function name.
+   * Library names should be specified as full names including prefix, extension, and version.
+   * For example, `getSymbol({ "libEGL.so.1", "libEGL.so" }, "eglGetProcAddress")` looks for the
+   * symbol `eglGetProcAddress` in the library `libEGL.so.1`, falling back to `libEGL.so`.
+   * Throw a loading_exception if it fails to find any library or a symbol_exception
+   * if the lib does not contain the expected symbol.
    */
-  [[nodiscard]] static function getSymbol(std::string_view lib, std::string_view func);
+  [[nodiscard]] static function getSymbol(
+    const std::vector<std::string>& libNames, std::string_view func);
 
   /**
    * An exception that can be thrown when the requested library cannot be loaded.
diff --git a/library/src/context.cxx b/library/src/context.cxx
index b404fd3..ccb37b0 100644
--- a/library/src/context.cxx
+++ b/library/src/context.cxx
@@ -13,20 +13,29 @@
 
 #include <vtksys/DynamicLoader.hxx>
 
+#include <string>
+#include <vector>
+
 namespace f3d
 {
 //----------------------------------------------------------------------------
-context::function context::getSymbol(std::string_view lib, std::string_view func)
+context::function context::getSymbol(
+  const std::vector<std::string>& libNames, std::string_view func)
 {
-  std::string libName = vtksys::DynamicLoader::LibPrefix();
-  libName += lib;
-  libName += vtksys::DynamicLoader::LibExtension();
+  vtksys::DynamicLoader::LibraryHandle handle = nullptr;
 
-  vtksys::DynamicLoader::LibraryHandle handle = vtksys::DynamicLoader::OpenLibrary(libName);
+  for (const auto& libName : libNames)
+  {
+    handle = vtksys::DynamicLoader::OpenLibrary(libName);
+    if (handle)
+    {
+      break;
+    }
+  }
 
   if (!handle)
   {
-    throw context::loading_exception("Cannot find " + std::string(lib) + " library");
+    throw context::loading_exception("Cannot find library");
   }
 
   using symbol = context::fptr (*)(const char*);
@@ -46,7 +55,8 @@ context::function context::getSymbol(std::string_view lib, std::string_view func
 context::function context::glx()
 {
 #if defined(VTK_USE_X) && VTK_VERSION_NUMBER >= VTK_VERSION_CHECK(9, 3, 20240914)
-  return getSymbol("GLX", "glXGetProcAddress");
+  // Try SONAME first (runtime), then unversioned (development)
+  return getSymbol({ "libGLX.so.0", "libGLX.so" }, "glXGetProcAddress");
 #else
   throw loading_exception("Cannot use a GLX context on this platform");
 #endif
@@ -91,19 +101,21 @@ context::function context::egl()
 {
 #if defined(VTK_OPENGL_HAS_EGL) && VTK_VERSION_NUMBER >= VTK_VERSION_CHECK(9, 3, 20240914)
   gladLoaderLoadEGL(EGL_NO_DISPLAY);
-  return getSymbol("EGL", "eglGetProcAddress");
+  // Try SONAME first (runtime), then unversioned (development)
+  return getSymbol({ "libEGL.so.1", "libEGL.so" }, "eglGetProcAddress");
 #else
   throw loading_exception("Cannot use a EGL context on this platform");
 #endif
 }
 
 //----------------------------------------------------------------------------
 context::function context::osmesa()
 {
 #if defined(__linux__) || defined(__FreeBSD__)
-  return getSymbol("OSMesa", "OSMesaGetProcAddress");
+  // OSMesa version varies; try common versions
+  return getSymbol({ "libOSMesa.so.8", "libOSMesa.so.6", "libOSMesa.so" }, "OSMesaGetProcAddress");
 #elif _WIN32
-  return getSymbol("osmesa", "OSMesaGetProcAddress");
+  return getSymbol({ "osmesa.dll" }, "OSMesaGetProcAddress");
 #else
   throw loading_exception("Cannot use a OSMesa context on this platform");
 #endif
--
libgit2 1.9.1

